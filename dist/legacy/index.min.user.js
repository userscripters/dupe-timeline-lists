// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Userscript for properly displaying duplicate lists in post timelines
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/dupe-timeline-lists#readme
// @match           https://*.stackexchange.com/posts/*/revisions*
// @match           https://*.stackexchange.com/posts/*/timeline*
// @match           https://askubuntu.com/posts/*/revisions*
// @match           https://askubuntu.com/posts/*/timeline*
// @match           https://es.meta.stackoverflow.com/posts/*/revisions*
// @match           https://es.meta.stackoverflow.com/posts/*/timeline*
// @match           https://es.stackoverflow.com/posts/*/revisions*
// @match           https://es.stackoverflow.com/posts/*/timeline*
// @match           https://ja.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ja.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ja.stackoverflow.com/posts/*/revisions*
// @match           https://ja.stackoverflow.com/posts/*/timeline*
// @match           https://mathoverflow.net/posts/*/revisions*
// @match           https://mathoverflow.net/posts/*/timeline*
// @match           https://meta.askubuntu.com/posts/*/revisions*
// @match           https://meta.askubuntu.com/posts/*/timeline*
// @match           https://meta.mathoverflow.net/posts/*/revisions*
// @match           https://meta.mathoverflow.net/posts/*/timeline*
// @match           https://meta.serverfault.com/posts/*/revisions*
// @match           https://meta.serverfault.com/posts/*/timeline*
// @match           https://meta.stackoverflow.com/posts/*/revisions*
// @match           https://meta.stackoverflow.com/posts/*/timeline*
// @match           https://meta.superuser.com/posts/*/revisions*
// @match           https://meta.superuser.com/posts/*/timeline*
// @match           https://pt.meta.stackoverflow.com/posts/*/revisions*
// @match           https://pt.meta.stackoverflow.com/posts/*/timeline*
// @match           https://pt.stackoverflow.com/posts/*/revisions*
// @match           https://pt.stackoverflow.com/posts/*/timeline*
// @match           https://ru.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ru.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ru.stackoverflow.com/posts/*/revisions*
// @match           https://ru.stackoverflow.com/posts/*/timeline*
// @match           https://serverfault.com/posts/*/revisions*
// @match           https://serverfault.com/posts/*/timeline*
// @match           https://stackapps.com/posts/*/revisions*
// @match           https://stackapps.com/posts/*/timeline*
// @match           https://stackoverflow.com/posts/*/revisions*
// @match           https://stackoverflow.com/posts/*/timeline*
// @match           https://superuser.com/posts/*/revisions*
// @match           https://superuser.com/posts/*/timeline*
// @name            Dupe Timeline Lists
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/dupe-timeline-lists.git
// @supportURL      https://github.com/userscripters/dupe-timeline-lists/issues
// @version         1.4.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,a,l,c){return new(l=l||Promise)(function(n,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(r,i)}o((c=c.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,i){var o,a,l,c={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(l=2&t[0]?a.return:t[0]?a.throw||((l=a.return)&&l.call(a),0):a.next)&&!(l=l.call(a,t[1])).done)return l;switch(a=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(l=0<(l=c.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){c.label=t[1];break}if(6===t[0]&&c.label<l[1]){c.label=l[1],l=t;break}if(l&&c.label<l[2]){c.label=l[2],c.ops.push(t);break}l[2]&&c.ops.pop(),c.trys.pop();continue}t=i.call(r,c)}catch(e){t=[6,e],a=0}finally{o=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)a.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||((r=r||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var _,y,b,l,g,c,w,x,E,A,S,C,r,k,n,R,t,i,o,q,a,d,u,s;return __generator(this,function(e){switch(e.label){case 0:return _=function(e){return __spreadArray([],__read(e.children),!1).forEach(function(e){return e.remove()})},y=function(e){return"A"===e.nodeName.toUpperCase()},b=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=document.createElement("a");return i.href=e,i.textContent=t,i.target="_blank",(e=i.classList).add.apply(e,__spreadArray([],__read(n),!1)),i},l=function(e){var t=document.createElement("span");return t.textContent=e.trim(),t},g=function(e){return e.href},c=function(e,t){void 0===t&&(t=!1);t=document.createElement(t?"ol":"ul"),t.classList.add("dupe-timeline-list"),e=e.map(function(e){var t=document.createElement("li");return t.append(e),t});return t.append.apply(t,__spreadArray([],__read(e),!1)),t},w=function(t,n){var e={added:[],removed:[]},r=e.added,i=e.removed;return t.forEach(function(e){return n.includes(e)||i.push(e)}),n.forEach(function(e){return t.includes(e)||r.push(e)}),e},x=function(e,t,n){return void 0===n&&(n="s"),"".concat(t).concat(1===e?"":n)},E=function(){var e=location.pathname;return __read(/posts\/(\d+)\/(?:revisions|timeline)/.exec(e)||[],2)[1]},A=function(e,t,n){var r=n.from,i=n.to,o=n.titles,n=(e.append(l(t)),r.flatMap(function(e,t){t=i[t];return e===t?b(e,o[e]):[b(e,o[e],"diff-removed"),b(t,o[t],"diff-added")]}));e.append(c(n))},S=function(e,t,n){var i=n.from,r=n.to,o=n.titles,a=(e.append(l(t)),i.map(function(e){return b.apply(void 0,__spreadArray([e,o[e]],__read(r.includes(e)?[]:["diff-removed"]),!1))}));r.forEach(function(e,t,n){var r;i.includes(e)||(r=n[t+1],n=a.findIndex(function(e){return e.href===r})+1,a.splice(n,0,b(e,o[e],"diff-added")))}),e.append(c(a))},C=function(e,t,n){var r=n.before,i=n.after,n=n.ordered,t=(e.append(l(t)),__read(n,2)),n=t[0],t=t[1];r&&e.append(c(r,n)),i&&e.append(c(i,t))},r=function(p,m,v,h){return void 0===h&&(h=!1),__awaiter(void 0,void 0,void 0,function(){var r,t,i,n,o,a,l,c,d,u,s,f;return __generator(this,function(e){switch(e.label){case 0:return(a=p.querySelector("span"))?(c=a.childNodes,c=__spreadArray([],__read(c),!1),-1===(l=c.findIndex(function(e){return e.textContent===R}))?(console.debug("[".concat(k,"] missing from/to separator text")),[2]):(r=c.slice(0,l).filter(y).map(g),t=c.slice(l+1).filter(y).map(g),c=w(r,t),l=c.added,c=c.removed,i={},a.querySelectorAll("a").forEach(function(e){var t=e.href,e=e.textContent;i[t]=e||t}),a=l.map(function(e){return b(e,i[e])}),l=c.map(function(e){return b(e,i[e])}),_(p),n=a.length,o=l.length,(n||o)&&h?[2,S(p,"Added ".concat(n,", removed ").concat(o," ").concat(x(o,"target")),{from:r,to:t,titles:i})]:(n&&C(p,"Added ".concat(n," duplicate ").concat(x(n,"target")),{before:a,ordered:[q||1<n]}),o&&C(p,"Removed ".concat(o," duplicate ").concat(x(o,"target")),{before:l,ordered:[q||1<o]}),n||o||!v?[3,3]:(c=E())?[4,fetch("/revisions/".concat(c,"/").concat(v))]:[2]))):(console.debug("[".concat(k,"] missing duplicate list edit ").concat(m," entry container")),[2]);case 1:return(a=e.sent()).ok?[4,a.text()]:[2];case 2:return l=e.sent(),c=$(l).find("[title='revision ".concat(v,"']")).next().contents().get(0),f=(null==(f=null==c?void 0:c.textContent)?void 0:f.trim())||"",f=__read(f.split(/\s+-\s+/),2),s=f[0],f=f[1],s=s.replace(/^from\s+/,"").split(","),f=f.replace(/^to\s+/,"").split(","),d=function(e){var t=new RegExp("\\/".concat(e,"\\/")),n=r.find(function(e){return t.test(e)});return n?b(n,i[n]):e},u=function(e){var t=new RegExp("\\/".concat(e,"\\/"));return r.find(function(e){return t.test(e)})||e},h?[2,A(p,"Reordered duplicate targets",{from:s.map(u),to:f.map(u),titles:i})]:[2,C(p,"Reordered duplicate targets",{before:s.map(d),after:f.map(d),ordered:[!0,!0]})];case 3:return n||o||!h?(n||o||(u=r.map(function(e){return b(e,i[e])}),s=t.map(function(e){return b(e,i[e])}),C(p,"Reordered duplicate targets",{before:u,after:s,ordered:[!0,!0]})),[2]):[2,A(p,"Reordered duplicate targets",{from:r,to:t,titles:i})]}})})},k="dupe-timeline-lists",n="duplicates list edited",R=" to ",function(){var e=document.createElement("style"),t=(document.head.append(e),e.sheet);t?["ul.dupe-timeline-list { list-style: none; margin-left: 0; }","ol.dupe-timeline-list { margin-left: 1em; }",".dupe-timeline-list:last-child { margin-bottom: 0; }",".dupe-timeline-list .diff-added,\n             .dupe-timeline-list .diff-removed {\n                margin-left: 1em;\n            }",".dupe-timeline-list .diff-added:before,\n             .dupe-timeline-list .diff-removed:before {\n                display: inline-block;\n                margin-left: -2em;\n                width: 1em;\n                text-align: center;\n                color: var(--black-750);\n            }",'.dupe-timeline-list .diff-added:before { content: "+"; }','.dupe-timeline-list .diff-removed:before { content: "-"; }'].forEach(function(e){return t.insertRule(e)}):console.debug("[".concat(k,"] missing stylesheet"))}(),t=Store.locateStorage(),t=new Store.default(k,t),i="always-use-lists",o="use-diff-view",[4,t.load(i,!1)];case 1:return q=e.sent(),[4,t.load(o,!1)];case 2:return a=e.sent(),[4,t.save(i,q)];case 3:return e.sent(),[4,t.save(o,a)];case 4:return(e.sent(),location.pathname.includes("revisions"))?((d=document.querySelector(".js-revisions"))?d.querySelectorAll(".js-revision > div").forEach(function(e){var e=__read(e.children,3),t=e[0],n=e[1];e[2];!((null==(e=null==n?void 0:n.textContent)?void 0:e.trim())||"").includes("duplicates list edited")||(t=(null==(e=null==t?void 0:t.textContent)?void 0:e.trim())||"")&&!Number.isNaN(+t)&&r(n,"revisions",t,a)}):console.debug("[".concat(k,"] missing revisions table")),[2]):((u=document.querySelector(".post-timeline"))?(s=new Set(["answered","asked","duplicates list edited","edited","rollback"]),u.querySelectorAll("tr").forEach(function(e){var t;"history"===e.dataset.eventtype&&(e=e.cells,(e=__read(e,6))[0],e[1],t=e[2],e[3],e[4],e=e[5],((null==(t=null==t?void 0:t.textContent)?void 0:t.trim())||"")===n&&(t=__spreadArray([],__read(u.rows),!1).reduce(function(e,t){var t=__read(t.cells,3),n=(t[0],t[1]),t=t[2];if("history"!==((null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||""))return e;t=(null==(n=null==t?void 0:t.textContent)?void 0:n.trim())||"";return s.has(t)?e+1:e},0),r(e,"timeline",t,a)))})):console.debug("[".concat(k,"] missing timeline table")),[2])}})})},{once:!0});