// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Userscript for properly displaying duplicate lists in post timelines
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/dupe-timeline-lists#readme
// @match           https://*.stackexchange.com/posts/*/revisions*
// @match           https://*.stackexchange.com/posts/*/timeline*
// @match           https://askubuntu.com/posts/*/revisions*
// @match           https://askubuntu.com/posts/*/timeline*
// @match           https://es.meta.stackoverflow.com/posts/*/revisions*
// @match           https://es.meta.stackoverflow.com/posts/*/timeline*
// @match           https://es.stackoverflow.com/posts/*/revisions*
// @match           https://es.stackoverflow.com/posts/*/timeline*
// @match           https://ja.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ja.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ja.stackoverflow.com/posts/*/revisions*
// @match           https://ja.stackoverflow.com/posts/*/timeline*
// @match           https://mathoverflow.net/posts/*/revisions*
// @match           https://mathoverflow.net/posts/*/timeline*
// @match           https://meta.askubuntu.com/posts/*/revisions*
// @match           https://meta.askubuntu.com/posts/*/timeline*
// @match           https://meta.mathoverflow.net/posts/*/revisions*
// @match           https://meta.mathoverflow.net/posts/*/timeline*
// @match           https://meta.serverfault.com/posts/*/revisions*
// @match           https://meta.serverfault.com/posts/*/timeline*
// @match           https://meta.stackoverflow.com/posts/*/revisions*
// @match           https://meta.stackoverflow.com/posts/*/timeline*
// @match           https://meta.superuser.com/posts/*/revisions*
// @match           https://meta.superuser.com/posts/*/timeline*
// @match           https://pt.meta.stackoverflow.com/posts/*/revisions*
// @match           https://pt.meta.stackoverflow.com/posts/*/timeline*
// @match           https://pt.stackoverflow.com/posts/*/revisions*
// @match           https://pt.stackoverflow.com/posts/*/timeline*
// @match           https://ru.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ru.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ru.stackoverflow.com/posts/*/revisions*
// @match           https://ru.stackoverflow.com/posts/*/timeline*
// @match           https://serverfault.com/posts/*/revisions*
// @match           https://serverfault.com/posts/*/timeline*
// @match           https://stackapps.com/posts/*/revisions*
// @match           https://stackapps.com/posts/*/timeline*
// @match           https://stackoverflow.com/posts/*/revisions*
// @match           https://stackoverflow.com/posts/*/timeline*
// @match           https://superuser.com/posts/*/revisions*
// @match           https://superuser.com/posts/*/timeline*
// @name            Dupe Timeline Lists
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/dupe-timeline-lists.git
// @supportURL      https://github.com/userscripters/dupe-timeline-lists/issues
// @version         1.5.4
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,a,l,d){return new(l=l||Promise)(function(n,t){function r(e){try{o(d.next(e))}catch(e){t(e)}}function i(e){try{o(d.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(r,i)}o((d=d.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,i){var o,a,l,d={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;d;)try{if(o=1,a&&(l=2&t[0]?a.return:t[0]?a.throw||((l=a.return)&&l.call(a),0):a.next)&&!(l=l.call(a,t[1])).done)return l;switch(a=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return d.label++,{value:t[1],done:!1};case 5:d.label++,a=t[1],t=[0];continue;case 7:t=d.ops.pop(),d.trys.pop();continue;default:if(!(l=0<(l=d.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){d=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){d.label=t[1];break}if(6===t[0]&&d.label<l[1]){d.label=l[1],l=t;break}if(l&&d.label<l[2]){d.label=l[2],d.ops.push(t);break}l[2]&&d.ops.pop(),d.trys.pop();continue}t=i.call(r,d)}catch(e){t=[6,e],a=0}finally{o=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)a.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||((r=r||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};window.addEventListener("load",function(){function T(e){return"A"===e.nodeName.toUpperCase()}function U(e){return e.href}function I(e,t,n){return void 0===n&&(n="s"),"".concat(t).concat(1===e?"":n)}function O(e,t,n){var r=void 0===(r=n.append)?[]:r,i=void 0===(i=n.before)?[]:i,o=void 0===(l=n.after)?[]:l,a=n.titles,l=(e.append(G(t)),i.flatMap(function(e,t){t=o[t];return e===t?D(e,a[e]):[D(e,a[e],"diff-removed"),D(t,a[t],"diff-added")]}));e.append.apply(e,__spreadArray([M(l)],__read(r),!1))}function P(e,t,n){var r=void 0===(r=n.append)?[]:r,i=n.before,o=n.after,a=n.ordered,l=n.titles;e.append(G(t));t=(n=__read(a,2))[0],a=n[1];i&&(n=i.map(function(e){return D(e,l[e])}),e.append(M(n,t))),o&&(i=o.map(function(e){return D(e,l[e])}),e.append(M(i,a))),e.append.apply(e,__spreadArray([],__read(r),!1))}function W(e,t){var n=new RegExp("\\/".concat(t,"\\/"));return e.find(function(e){return n.test(e)})||t}function S(q,L,N,R,j){void 0===R&&(R=!1),void 0===j&&(j=!1),__awaiter(void 0,void 0,void 0,function(){var v,m,y,_,h,b,g,w,x,A,E,S,k,C;return __generator(this,function(e){switch(e.label){case 0:return(k=q.querySelector("span"))?(A=k.childNodes,A=__spreadArray([],__read(A),!1),-1===(x=A.findIndex(function(e){return" to "===e.textContent}))?(console.debug("[".concat(V,"] missing from/to separator text")),[2]):(v=A.slice(0,x).filter(T).map(U),m=A.slice(x+1).filter(T).map(U),c=v,s=m,f=(u={added:[],removed:[]}).added,p=u.removed,c.forEach(function(e){return s.includes(e)||p.push(e)}),s.forEach(function(e){return c.includes(e)||f.push(e)}),y=u.added,_=u.removed,h={},k.querySelectorAll("a").forEach(function(e){var t=e.href,e=e.textContent;h[t]=e||t}),b=y.length,g=_.length,u=location.pathname,(A=__read(/posts\/(\d+)\/(?:revisions|timeline)/.exec(u)||[],2)[1])?(w="/revisions/".concat(A,"/").concat(N),[4,fetch(w)]):[2])):(console.debug("[".concat(V,"] missing duplicate list edit ").concat(L," entry container")),[2]);case 1:return(x=e.sent()).ok?(A=null==(k=q.querySelector("[href*='".concat(w,"']")))?void 0:k.parentElement,E=A?[A]:[],__spreadArray([],__read(q.children),!1).forEach(function(e){return e.remove()}),[4,x.text()]):[2];case 2:return(C=e.sent(),C=$(C).find("[title='revision ".concat(N,"']")).next().contents().get(0),C=(null==(C=null==C?void 0:C.textContent)?void 0:C.trim())||"",C=__read(C.split(/\s+-\s+/),2),S=C[0],C=C[1],S=S.replace(/^from\s+/,"").split(","),C=C.replace(/^to\s+/,"").split(","),S=S.map(function(e){return W(v,e)}),C=C.map(function(e){return W(m,e)}),(b||g)&&j)?[2,(u=q,t="Added ".concat(b,", removed ").concat(g," ").concat(I(g,"target")),r=void 0===(r=(n={append:E,before:S,after:C,titles:h}).append)?[]:r,i=n.before,o=void 0===i?[]:i,i=n.after,a=void 0===i?[]:i,l=n.titles,u.append(G(t)),d=o.map(function(e){return D.apply(void 0,__spreadArray([e,l[e]],__read(a.includes(e)?[]:["diff-removed"]),!1))}),a.forEach(function(e,t,n){var r;o.includes(e)||(e=D(e,l[e],"diff-added"),(r=n[t+1])?(n=d.findIndex(function(e){return e.href===r}),d.splice(n,0,e)):d.push(e))}),void u.append.apply(u,__spreadArray([M(d)],__read(r),!1)))]:b||g?(b&&P(q,"Added ".concat(b," duplicate ").concat(I(b,"target")),{append:E,before:y,ordered:[R||1<b],titles:h}),g&&P(q,"Removed ".concat(g," duplicate ").concat(I(g,"target")),{append:E,before:_,ordered:[R||1<g],titles:h}),[2]):[2,(j?O:P)(q,"Reordered duplicate targets",{append:E,before:S,after:C,titles:h,ordered:[!0,!0]})]}var t,n,r,i,o,a,l,d,c,s,u,f,p})})}var D=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=document.createElement("a");return i.href=e,i.textContent=t,i.target="_blank",(e=i.classList).add.apply(e,__spreadArray([],__read(n),!1)),i},G=function(e){var t=document.createElement("span");return t.textContent=e.trim(),t},M=function(e,t){void 0===t&&(t=!1);t=document.createElement(t?"ol":"ul"),t.classList.add("dupe-timeline-list"),e=e.map(function(e){var t=document.createElement("li");return t.append(e),t});return t.append.apply(t,__spreadArray([],__read(e),!1)),t},V="dupe-timeline-lists",k="list-type",C="view-type",q="use-color-diffs";unsafeWindow.addEventListener("userscript-configurer-load",function(){return __awaiter(void 0,void 0,void 0,function(){var d,c,s,u,f,p,v,m,y,_,h,b,g,w,x,A,E;return __generator(this,function(e){switch(e.label){case 0:return(A=null==(A=null==(A=unsafeWindow.UserScripters)?void 0:A.Userscripts)?void 0:A.Configurer)?((d=A.register(V)).option(k,{items:[{label:"Always ordered",value:"always-ordered"},{label:"Only multiple",value:"only-multiple"}],def:"always-ordered",title:"List type (list view-only)",desc:"",type:"select"}),d.option(C,{items:[{label:"List view",value:"list"},{label:"Diff view",value:"diff"}],def:"list",title:"View preference",desc:"",type:"select"}),d.option(q,{def:!1,desc:"",title:"Colored diffs (diff view-only)",type:"toggle"}),[4,d.load(q,!0)]):(console.debug("[".concat(V,"] missing script configurer")),[2]);case 1:return c=e.sent(),[4,d.load(k,"only-multiple")];case 2:return s=e.sent(),[4,d.load(C,"list")];case 3:if(A=e.sent(),u="always-ordered"===s,n=f="diff"===A,o=c,a=document.createElement("style"),document.head.append(a),(l=a.sheet)?(a=["ul.dupe-timeline-list { list-style: none; margin-left: 0; }","ol.dupe-timeline-list { margin-left: 1em; }",".dupe-timeline-list:last-child { margin-bottom: 0; }",".dupe-timeline-list .diff-added,\n             .dupe-timeline-list .diff-removed {\n                padding-left: 1em;\n            }",".dupe-timeline-list .diff-added:before,\n             .dupe-timeline-list .diff-removed:before {\n                display: inline-block;\n                margin-left: -2em;\n                width: 1em;\n                text-align: center;\n                color: var(--black-750);\n            }",'.dupe-timeline-list .diff-added:before { content: "+"; }','.dupe-timeline-list .diff-removed:before { content: "-"; }'],n&&o&&a.push.apply(a,[".dupe-timeline-list a.diff-added,\n                 .dupe-timeline-list a.diff-removed {\n                    text-decoration: underline var(--theme-link-color);\n                }",".dupe-timeline-list .diff-added {\n                    background: var(--green-100);\n                    color: var(--green-800);\n                }",".dupe-timeline-list .diff-removed {\n                    color: var(--red-800);\n                    background-color: var(--red-200);\n                }"]),a.forEach(function(e){return l.insertRule(e)})):console.debug("[".concat(V,"] missing stylesheet")),location.pathname.includes("revisions"))return(p=document.querySelector(".js-revisions"))?p.querySelectorAll(".js-revision > div").forEach(function(e){var e=__read(e.children,3),t=e[0],n=e[1];e[2];!((null==(e=null==n?void 0:n.textContent)?void 0:e.trim())||"").includes("duplicates list edited")||(t=(null==(e=null==t?void 0:t.textContent)?void 0:e.trim())||"")&&!Number.isNaN(+t)&&S(n,"revisions",t,u,f)}):console.debug("[".concat(V,"] missing revisions table")),[2];if(!(p=document.querySelector(".post-timeline")))return console.debug("[".concat(V,"] missing timeline table")),[2];v=new Set(["answered","asked","duplicates list edited","edited","rollback"]),m=__spreadArray([],__read(p.rows),!1),y=-1,e.label=4;case 4:e.trys.push([4,10,11,12]),_=__values(m),h=_.next(),e.label=5;case 5:return h.done?[3,9]:(b=h.value,(y+=1)||y%10?[3,7]:[4,(t=500,new Promise(function(e){return setTimeout(e,t)}))]);case 6:e.sent(),e.label=7;case 7:if(g=b.dataset,"history"!==g.eventtype)return[3,8];if(g=b.cells,g=__read(g,6),g[0],g[1],E=g[2],g[3],g[4],g=g[5],"duplicates list edited"!==((null==(E=null==E?void 0:E.textContent)?void 0:E.trim())||""))return[3,8];r=v,i=y,E=m.reduceRight(function(e,t,n){if(n<i)return e;var n=__read(t.cells,3),t=(n[0],n[1]),n=n[2];if("history"!==((null==(t=null==t?void 0:t.textContent)?void 0:t.trim())||""))return e;n=(null==(t=null==n?void 0:n.textContent)?void 0:t.trim())||"";return r.has(n)?e+1:e},0),S(g,"timeline",E,u,f),e.label=8;case 8:return h=_.next(),[3,5];case 9:return[3,12];case 10:return g=e.sent(),w={error:g},[3,12];case 11:try{h&&!h.done&&(x=_.return)&&x.call(_)}finally{if(w)throw w.error}return[7];case 12:return[2]}var r,i,t,n,o,a,l})})},{once:!0})},{once:!0});