// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Userscript for properly displaying duplicate lists in post timelines
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/dupe-timeline-lists#readme
// @match           https://*.stackexchange.com/posts/*/revisions*
// @match           https://*.stackexchange.com/posts/*/timeline*
// @match           https://askubuntu.com/posts/*/revisions*
// @match           https://askubuntu.com/posts/*/timeline*
// @match           https://es.meta.stackoverflow.com/posts/*/revisions*
// @match           https://es.meta.stackoverflow.com/posts/*/timeline*
// @match           https://es.stackoverflow.com/posts/*/revisions*
// @match           https://es.stackoverflow.com/posts/*/timeline*
// @match           https://ja.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ja.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ja.stackoverflow.com/posts/*/revisions*
// @match           https://ja.stackoverflow.com/posts/*/timeline*
// @match           https://mathoverflow.net/posts/*/revisions*
// @match           https://mathoverflow.net/posts/*/timeline*
// @match           https://meta.askubuntu.com/posts/*/revisions*
// @match           https://meta.askubuntu.com/posts/*/timeline*
// @match           https://meta.mathoverflow.net/posts/*/revisions*
// @match           https://meta.mathoverflow.net/posts/*/timeline*
// @match           https://meta.serverfault.com/posts/*/revisions*
// @match           https://meta.serverfault.com/posts/*/timeline*
// @match           https://meta.stackoverflow.com/posts/*/revisions*
// @match           https://meta.stackoverflow.com/posts/*/timeline*
// @match           https://meta.superuser.com/posts/*/revisions*
// @match           https://meta.superuser.com/posts/*/timeline*
// @match           https://pt.meta.stackoverflow.com/posts/*/revisions*
// @match           https://pt.meta.stackoverflow.com/posts/*/timeline*
// @match           https://pt.stackoverflow.com/posts/*/revisions*
// @match           https://pt.stackoverflow.com/posts/*/timeline*
// @match           https://ru.meta.stackoverflow.com/posts/*/revisions*
// @match           https://ru.meta.stackoverflow.com/posts/*/timeline*
// @match           https://ru.stackoverflow.com/posts/*/revisions*
// @match           https://ru.stackoverflow.com/posts/*/timeline*
// @match           https://serverfault.com/posts/*/revisions*
// @match           https://serverfault.com/posts/*/timeline*
// @match           https://stackapps.com/posts/*/revisions*
// @match           https://stackapps.com/posts/*/timeline*
// @match           https://stackoverflow.com/posts/*/revisions*
// @match           https://stackoverflow.com/posts/*/timeline*
// @match           https://superuser.com/posts/*/revisions*
// @match           https://superuser.com/posts/*/timeline*
// @name            Dupe Timeline Lists
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/dupe-timeline-lists.git
// @supportURL      https://github.com/userscripters/dupe-timeline-lists/issues
// @version         1.5.3
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,o,d,l){return new(d=d||Promise)(function(n,t){function r(e){try{a(l.next(e))}catch(e){t(e)}}function i(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?n(e.value):((t=e.value)instanceof d?t:new d(function(e){e(t)})).then(r,i)}a((l=l.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(r,i){var a,o,d,l={label:0,sent:function(){if(1&d[0])throw d[1];return d[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,o&&(d=2&t[0]?o.return:t[0]?o.throw||((d=o.return)&&d.call(o),0):o.next)&&!(d=d.call(o,t[1])).done)return d;switch(o=0,(t=d?[2&t[0],d.value]:t)[0]){case 0:case 1:d=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,o=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(d=0<(d=l.trys).length&&d[d.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!d||t[1]>d[0]&&t[1]<d[3])){l.label=t[1];break}if(6===t[0]&&l.label<d[1]){l.label=d[1],d=t;break}if(d&&l.label<d[2]){l.label=d[2],l.ops.push(t);break}d[2]&&l.ops.pop(),l.trys.pop();continue}t=i.call(r,l)}catch(e){t=[6,e],o=0}finally{a=d=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,a=n.call(e),o=[];try{for(;(void 0===t||0<t--)&&!(r=a.next()).done;)o.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}return o},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,a=t.length;i<a;i++)!r&&i in t||((r=r||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var t,b,g,c,u,w,s,x,A,E,S,k,C,r,q,i,N,a,R,n,o,d,l,L,f,p,v,m,_;return __generator(this,function(e){switch(e.label){case 0:return t=function(e,t){var n=document.createElement("style"),r=(document.head.append(n),n.sheet);r?(n=["ul.dupe-timeline-list { list-style: none; margin-left: 0; }","ol.dupe-timeline-list { margin-left: 1em; }",".dupe-timeline-list:last-child { margin-bottom: 0; }",".dupe-timeline-list .diff-added,\n             .dupe-timeline-list .diff-removed {\n                padding-left: 1em;\n            }",".dupe-timeline-list .diff-added:before,\n             .dupe-timeline-list .diff-removed:before {\n                display: inline-block;\n                margin-left: -2em;\n                width: 1em;\n                text-align: center;\n                color: var(--black-750);\n            }",'.dupe-timeline-list .diff-added:before { content: "+"; }','.dupe-timeline-list .diff-removed:before { content: "-"; }'],e&&t&&n.push.apply(n,[".dupe-timeline-list a.diff-added,\n                 .dupe-timeline-list a.diff-removed {\n                    text-decoration: underline var(--theme-link-color);\n                }",".dupe-timeline-list .diff-added {\n                    background: var(--green-100);\n                    color: var(--green-800);\n                }",".dupe-timeline-list .diff-removed {\n                    color: var(--red-800);\n                    background-color: var(--red-200);\n                }"]),n.forEach(function(e){return r.insertRule(e)})):console.debug("[".concat(N,"] missing stylesheet"))},b=function(e){return __spreadArray([],__read(e.children),!1).forEach(function(e){return e.remove()})},g=function(e){return"A"===e.nodeName.toUpperCase()},c=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=document.createElement("a");return i.href=e,i.textContent=t,i.target="_blank",(e=i.classList).add.apply(e,__spreadArray([],__read(n),!1)),i},u=function(e){var t=document.createElement("span");return t.textContent=e.trim(),t},w=function(e){return e.href},s=function(e,t){void 0===t&&(t=!1);t=document.createElement(t?"ol":"ul"),t.classList.add("dupe-timeline-list"),e=e.map(function(e){var t=document.createElement("li");return t.append(e),t});return t.append.apply(t,__spreadArray([],__read(e),!1)),t},x=function(t,n){var e={added:[],removed:[]},r=e.added,i=e.removed;return t.forEach(function(e){return n.includes(e)||i.push(e)}),n.forEach(function(e){return t.includes(e)||r.push(e)}),e},A=function(e,t,n){return void 0===n&&(n="s"),"".concat(t).concat(1===e?"":n)},E=function(){var e=location.pathname;return __read(/posts\/(\d+)\/(?:revisions|timeline)/.exec(e)||[],2)[1]},S=function(e,t,n){var r=n.append,r=void 0===r?[]:r,i=n.before,i=void 0===i?[]:i,a=n.after,o=void 0===a?[]:a,d=n.titles,a=(e.append(u(t)),i.flatMap(function(e,t){t=o[t];return e===t?c(e,d[e]):[c(e,d[e],"diff-removed"),c(t,d[t],"diff-added")]}));e.append.apply(e,__spreadArray([s(a)],__read(r),!1))},k=function(e,t,n){var r=n.append,r=void 0===r?[]:r,i=n.before,a=void 0===i?[]:i,i=n.after,o=void 0===i?[]:i,d=n.titles,l=(e.append(u(t)),a.map(function(e){return c.apply(void 0,__spreadArray([e,d[e]],__read(o.includes(e)?[]:["diff-removed"]),!1))}));o.forEach(function(e,t,n){var r;a.includes(e)||(e=c(e,d[e],"diff-added"),(r=n[t+1])?(n=l.findIndex(function(e){return e.href===r}),l.splice(n,0,e)):l.push(e))}),e.append.apply(e,__spreadArray([s(l)],__read(r),!1))},C=function(e,t,n){var r=n.append,r=void 0===r?[]:r,i=n.before,a=n.after,o=n.ordered,d=n.titles,n=(e.append(u(t)),__read(o,2)),t=n[0],o=n[1];i&&(n=i.map(function(e){return c(e,d[e])}),e.append(s(n,t))),a&&(i=a.map(function(e){return c(e,d[e])}),e.append(s(i,o))),e.append.apply(e,__spreadArray([],__read(r),!1))},r=function(e,r){return e.reduceRight(function(e,t,n){if(n<r)return e;var n=__read(t.cells,3),t=(n[0],n[1]),n=n[2];if("history"!==((null==(t=null==t?void 0:t.textContent)?void 0:t.trim())||""))return e;n=(null==(t=null==n?void 0:n.textContent)?void 0:t.trim())||"";return m.has(n)?e+1:e},0)},q=function(e,t){var n=new RegExp("\\/".concat(t,"\\/"));return e.find(function(e){return n.test(e)})||t},i=function(m,_,h,y){return void 0===y&&(y=!1),__awaiter(void 0,void 0,void 0,function(){var t,n,r,i,a,o,d,l,c,u,s,f,p,v;return __generator(this,function(e){switch(e.label){case 0:return(p=m.querySelector("span"))?(c=p.childNodes,c=__spreadArray([],__read(c),!1),-1===(u=c.findIndex(function(e){return e.textContent===R}))?(console.debug("[".concat(N,"] missing from/to separator text")),[2]):(t=c.slice(0,u).filter(g).map(w),n=c.slice(u+1).filter(g).map(w),c=x(t,n),r=c.added,i=c.removed,a={},p.querySelectorAll("a").forEach(function(e){var t=e.href,e=e.textContent;a[t]=e||t}),o=r.length,d=i.length,(u=E())?(l="/revisions/".concat(u,"/").concat(h),[4,fetch(l)]):[2])):(console.debug("[".concat(N,"] missing duplicate list edit ").concat(_," entry container")),[2]);case 1:return(c=e.sent()).ok?(u=null==(p=m.querySelector("[href*='".concat(l,"']")))?void 0:p.parentElement,s=u?[u]:[],b(m),[4,c.text()]):[2];case 2:return(v=e.sent(),v=$(v).find("[title='revision ".concat(h,"']")).next().contents().get(0),v=(null==(v=null==v?void 0:v.textContent)?void 0:v.trim())||"",v=__read(v.split(/\s+-\s+/),2),f=v[0],v=v[1],f=f.replace(/^from\s+/,"").split(","),v=v.replace(/^to\s+/,"").split(","),f=f.map(function(e){return q(t,e)}),v=v.map(function(e){return q(n,e)}),(o||d)&&y)?[2,k(m,"Added ".concat(o,", removed ").concat(d," ").concat(A(d,"target")),{append:s,before:f,after:v,titles:a})]:o||d?(o&&C(m,"Added ".concat(o," duplicate ").concat(A(o,"target")),{append:s,before:r,ordered:[L||1<o],titles:a}),d&&C(m,"Removed ".concat(d," duplicate ").concat(A(d,"target")),{append:s,before:i,ordered:[L||1<d],titles:a}),[2]):[2,(y?S:C)(m,"Reordered duplicate targets",{append:s,before:f,after:v,titles:a,ordered:[!0,!0]})]}})})},N="dupe-timeline-lists",a="duplicates list edited",R=" to ",n=Store.locateStorage(),n=new Store.default(N,n),o="always-use-lists",d="use-diff-view",l="use-color-diffs",[4,n.load(o,!1)];case 1:return L=e.sent(),[4,n.load(d,!1)];case 2:return f=e.sent(),[4,n.load(l,!1)];case 3:return p=e.sent(),[4,n.save(o,L)];case 4:return e.sent(),[4,n.save(d,f)];case 5:return e.sent(),[4,n.save(l,p)];case 6:return(e.sent(),t(f,p),location.pathname.includes("revisions"))?((v=document.querySelector(".js-revisions"))?v.querySelectorAll(".js-revision > div").forEach(function(e){var e=__read(e.children,3),t=e[0],n=e[1];e[2];!((null==(e=null==n?void 0:n.textContent)?void 0:e.trim())||"").includes("duplicates list edited")||(t=(null==(e=null==t?void 0:t.textContent)?void 0:e.trim())||"")&&!Number.isNaN(+t)&&i(n,"revisions",t,f)}):console.debug("[".concat(N,"] missing revisions table")),[2]):((v=document.querySelector(".post-timeline"))?(m=new Set(["answered","asked","duplicates list edited","edited","rollback"]),(_=__spreadArray([],__read(v.rows),!1)).forEach(function(e,t){var n;"history"===e.dataset.eventtype&&(e=e.cells,(e=__read(e,6))[0],e[1],n=e[2],e[3],e[4],e=e[5],((null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||"")===a&&(n=r(_,t),i(e,"timeline",n,f)))})):console.debug("[".concat(N,"] missing timeline table")),[2])}})})},{once:!0});